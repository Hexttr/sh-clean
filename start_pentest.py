#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Запуск пентеста Shannon на сервере.
Цель: Juice Shop на http://72.56.79.153:3001
"""
import os
import sys
import paramiko
import time
from dotenv import load_dotenv

if sys.platform == 'win32':
    import codecs
    sys.stdout = codecs.getwriter('utf-8')(sys.stdout.buffer, 'strict')
    sys.stderr = codecs.getwriter('utf-8')(sys.stderr.buffer, 'strict')

load_dotenv()

SSH_HOST = os.getenv('SSH_HOST', '72.56.79.153')
SSH_USER = os.getenv('SSH_USER', 'root')
SSH_PASSWORD = os.getenv('SSH_PASSWORD', 'm8J@2_6whwza6U')
SSH_PORT = int(os.getenv('SSH_PORT', 22))

# URL для пентеста: сервер должен быть доступен из worker-контейнера
# Используем внешний IP - worker на том же хосте сможет достучаться
TARGET_URL = f"http://{SSH_HOST}:3001"

def run_cmd(client, cmd, timeout=60):
    stdin, stdout, stderr = client.exec_command(cmd, timeout=timeout)
    exit_status = stdout.channel.recv_exit_status()
    out = stdout.read().decode('utf-8', errors='ignore')
    err = stderr.read().decode('utf-8', errors='ignore')
    return exit_status == 0, out, err

def main():
    print("=" * 70)
    print("  ЗАПУСК ПЕНТЕСТА SHANNON")
    print("=" * 70)
    print(f"\nСервер: {SSH_HOST}")
    print(f"Цель: Juice Shop - {TARGET_URL}")

    try:
        client = paramiko.SSHClient()
        client.set_missing_host_key_policy(paramiko.AutoAddPolicy())
        client.connect(
            hostname=SSH_HOST,
            username=SSH_USER,
            password=SSH_PASSWORD,
            port=SSH_PORT,
            timeout=15
        )

        # 1. Убедиться что Juice Shop доступен
        print("\n[1/5] Проверка доступности Juice Shop...")
        ok, out, _ = run_cmd(client, f"curl -s -o /dev/null -w '%{{http_code}}' {TARGET_URL}")
        if out and out.strip() == '200':
            print(f"      [OK] Juice Shop отвечает HTTP 200")
        else:
            print(f"      [WARN] Juice Shop: HTTP {out.strip() or 'no response'}")
            print("      Продолжаем...")

        # 2. Клонировать репозиторий Juice Shop если пусто
        print("\n[2/5] Подготовка репозитория...")
        ok, out, _ = run_cmd(client, "test -d /root/shannon/repos/juice-shop/.git && echo EXISTS || echo MISSING")
        if 'MISSING' in (out or ""):
            print("      Клонируем juice-shop...")
            ok, clone_out, _ = run_cmd(client,
                "cd /root/shannon/repos && git clone --depth 1 https://github.com/juice-shop/juice-shop.git 2>&1",
                timeout=120)
            if ok:
                print("      [OK] juice-shop клонирован")
            else:
                print(f"      [WARN] Клон не удался: {clone_out[:150]}...")
            REPO_PATH = "/root/shannon/repos/juice-shop" if ok else "/root/shannon"
        else:
            print("      [OK] juice-shop уже есть")
            REPO_PATH = "/root/shannon/repos/juice-shop"

        # 3. Запустить Shannon (поднимет контейнеры)
        print("\n[3/5] Запуск Shannon...")
        cmd = f"cd /root/shannon && ./shannon start URL={TARGET_URL} REPO={REPO_PATH}"
        print(f"      Команда: {cmd}")
        ok, out, err = run_cmd(client, cmd, timeout=120)
        print(out)
        if err:
            print(err, file=sys.stderr)

        if not ok:
            print("\n[ERROR] Не удалось запустить пентест")
            return False

        # 4. Извлечь Workflow ID
        print("\n[4/5] Поиск Workflow ID...")
        time.sleep(5)
        ok, out, _ = run_cmd(client, "docker compose -f /root/shannon/docker-compose.yml exec -T worker cat /proc/1/fd/1 2>/dev/null || true")
        ok, out, _ = run_cmd(client, "ls -t /root/shannon/audit-logs/ | grep shannon | head -1")
        workflow_id = out.strip() if out else ""
        if not workflow_id:
            # Пробуем из логов
            ok, out, _ = run_cmd(client, "docker compose -f /root/shannon/docker-compose.yml logs worker 2>&1 | grep -oE 'shannon-[0-9]+|localhost_shannon-[0-9]+' | tail -1")
            workflow_id = out.strip() if out else ""

        # 5. Инструкции
        print("\n[5/5] Готово!")
        print("\n" + "=" * 70)
        print("  АДРЕСА И КОМАНДЫ")
        print("=" * 70)
        print(f"""
  Цель для пентеста (проверьте в браузере):
    {TARGET_URL}

  Temporal Web UI (мониторинг):
    http://{SSH_HOST}:8233

  Команды для мониторинга (SSH):
    ssh {SSH_USER}@{SSH_HOST}
    cd /root/shannon
    ./shannon query ID=<workflow-id>
    ./shannon logs ID=<workflow-id>

  Результаты после завершения:
    /root/shannon/audit-logs/<workflow-id>/deliverables/
    comprehensive_security_assessment_report.md

  Время выполнения: ~1-1.5 часа
  Стоимость: ~$50 USD
""")
        if workflow_id:
            print(f"  Workflow ID: {workflow_id}\n")
        print("=" * 70)

        client.close()
        return True

    except Exception as e:
        print(f"\n[ERROR] {e}")
        import traceback
        traceback.print_exc()
        return False

if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)
