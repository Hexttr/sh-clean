#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Скрипт для запуска тестового пентеста Shannon
"""
import os
import sys
import paramiko
from dotenv import load_dotenv
import time

if sys.platform == 'win32':
    import codecs
    sys.stdout = codecs.getwriter('utf-8')(sys.stdout.buffer, 'strict')
    sys.stderr = codecs.getwriter('utf-8')(sys.stderr.buffer, 'strict')

load_dotenv()

def execute_command(client, command, description):
    """Выполняет команду на сервере"""
    print(f"\n--- {description} ---")
    stdin, stdout, stderr = client.exec_command(command)
    exit_status = stdout.channel.recv_exit_status()
    output = stdout.read().decode('utf-8', errors='ignore')
    error = stderr.read().decode('utf-8', errors='ignore')
    
    if output:
        print(output)
    if error and exit_status != 0:
        print(f"[WARNING] {error}")
    
    return exit_status == 0, output

def run_test_pentest():
    """Запуск тестового пентеста"""
    host = os.getenv('SSH_HOST')
    username = os.getenv('SSH_USER')
    password = os.getenv('SSH_PASSWORD')
    port = int(os.getenv('SSH_PORT', 22))
    
    print("=" * 60)
    print("ЗАПУСК ТЕСТОВОГО ПЕНТЕСТА SHANNON")
    print("=" * 60)
    
    try:
        client = paramiko.SSHClient()
        client.set_missing_host_key_policy(paramiko.AutoAddPolicy())
        client.connect(
            hostname=host,
            username=username,
            password=password,
            port=port,
            timeout=10
        )
        
        print("\n[OK] Подключено к серверу")
        
        # 1. Проверяем статус контейнеров
        print("\n=== 1. ПРОВЕРКА КОНТЕЙНЕРОВ ===")
        execute_command(client, "docker ps --filter 'name=shannon'", "Контейнеры Shannon")
        
        # 2. Проверяем доступность Juice Shop
        print("\n=== 2. ПРОВЕРКА ДОСТУПНОСТИ ЦЕЛЕВОГО ПРИЛОЖЕНИЯ ===")
        execute_command(client, 
            "curl -s -o /dev/null -w '%{http_code}' http://localhost:3001 || echo 'Недоступен'",
            "HTTP статус Juice Shop")
        
        # 3. Проверяем наличие API ключа
        print("\n=== 3. ПРОВЕРКА API КЛЮЧА ===")
        stdin, stdout, stderr = client.exec_command(
            "grep -c 'ANTHROPIC_API_KEY=' /root/shannon/.env | grep -v '^0$' && echo 'OK' || echo 'НЕ НАЙДЕН'"
        )
        key_status = stdout.read().decode('utf-8', errors='ignore').strip()
        if 'OK' in key_status:
            print("[OK] API ключ найден")
        else:
            print("[ERROR] API ключ не найден! Добавьте его в /root/shannon/.env")
            return False
        
        # 4. Останавливаем старые workflow если есть
        print("\n=== 4. ОСТАНОВКА СТАРЫХ WORKFLOW ===")
        execute_command(client, 
            "cd /root/shannon && docker-compose down 2>&1 || true",
            "Остановка контейнеров")
        
        time.sleep(2)
        
        # 5. Запускаем тестовый пентест
        print("\n=== 5. ЗАПУСК ПЕНТЕСТА ===")
        print("Цель: Juice Shop (http://localhost:3001)")
        print("Репозиторий: /root/shannon (для примера)")
        print("\nЗапускаем...")
        
        # Запускаем в фоне и сохраняем вывод
        stdin, stdout, stderr = client.exec_command(
            "cd /root/shannon && nohup ./shannon start URL=http://localhost:3001 REPO=/root/shannon > /tmp/shannon_pentest.log 2>&1 & echo $!"
        )
        pid = stdout.read().decode('utf-8', errors='ignore').strip()
        
        print(f"[OK] Пентест запущен (PID: {pid})")
        print("\nОжидание 10 секунд для инициализации...")
        time.sleep(10)
        
        # 6. Проверяем логи запуска
        print("\n=== 6. ЛОГИ ЗАПУСКА ===")
        execute_command(client,
            "tail -50 /tmp/shannon_pentest.log 2>&1",
            "Последние логи")
        
        # 7. Проверяем статус контейнеров
        print("\n=== 7. СТАТУС КОНТЕЙНЕРОВ ===")
        execute_command(client, "docker ps --filter 'name=shannon'", "Запущенные контейнеры")
        
        # 8. Извлекаем Workflow ID из логов
        print("\n=== 8. WORKFLOW ID ===")
        stdin, stdout, stderr = client.exec_command(
            "grep -o 'shannon-[0-9]*\\|localhost_shannon-[0-9]*' /tmp/shannon_pentest.log | head -1"
        )
        workflow_id = stdout.read().decode('utf-8', errors='ignore').strip()
        
        if workflow_id:
            print(f"[OK] Workflow ID: {workflow_id}")
            print(f"\nДля мониторинга используйте:")
            print(f"  ssh root@72.56.79.153")
            print(f"  cd /root/shannon")
            print(f"  ./shannon query ID={workflow_id}")
            print(f"  ./shannon logs ID={workflow_id}")
        else:
            print("[INFO] Workflow ID еще не определен, проверьте логи позже")
        
        print("\n" + "=" * 60)
        print("ПЕНТЕСТ ЗАПУЩЕН!")
        print("=" * 60)
        print("\nМониторинг:")
        print("1. Веб-интерфейс Temporal: http://72.56.79.153:8233")
        print("2. Логи: ssh root@72.56.79.153 'cd /root/shannon && ./shannon logs ID=<workflow-id>'")
        print("3. Статус: ssh root@72.56.79.153 'cd /root/shannon && ./shannon query ID=<workflow-id>'")
        print("\nВремя выполнения: 1-1.5 часа")
        print("Примерная стоимость: ~$50 USD")
        
        client.close()
        return True
        
    except Exception as e:
        print(f"[ERROR] Ошибка: {e}")
        import traceback
        traceback.print_exc()
        return False

if __name__ == "__main__":
    run_test_pentest()

